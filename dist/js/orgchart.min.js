"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),OrgChart=function(){function e(t){_classCallCheck(this,e),this._name="OrgChart",this.ghostLines=[],this.additionalClasses=[],Promise.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){throw n})})};var n=this,i={nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1,hideOnlyParent:!0,hideSiblings:!0,animateLines:!0,additionalClasses:"additional-classes"},s=Object.assign(i,t),r=s.data,a=document.createElement("div"),o=document.querySelector(s.chartContainer);if(this.options=s,delete this.options.data,this.chart=a,this.chartContainer=o,a.dataset.options=JSON.stringify(s),a.setAttribute("class","orgchart"+(""!==s.chartClass?" "+s.chartClass:"")+("t2b"!==s.direction?" "+s.direction:"")),"object"===(void 0===r?"undefined":_typeof(r)))this.buildHierarchy(a,s.ajaxURL?r:this._attachRel(r,"00"),0);else if("string"==typeof r&&r.startsWith("#"))this.buildHierarchy(a,this._buildJsonDS(document.querySelector(r).children[0]),0);else{var l=document.createElement("i");l.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),a.appendChild(l),this._getJSON(r).then(function(e){n.buildHierarchy(a,s.ajaxURL?e:n._attachRel(e,"00"),0)}).catch(function(e){console.error("failed to fetch datasource for orgchart",e)}).finally(function(){var e=a.querySelector(".spinner");e.parentNode.removeChild(e)})}if(a.addEventListener("click",this._clickChart.bind(this)),s.exportButton&&!o.querySelector(".oc-export-btn")){var d=document.createElement("button"),c=document.createElement("a");d.setAttribute("class","oc-export-btn"+(""!==s.chartClass?" "+s.chartClass:"")),d.innerHTML="Export",d.addEventListener("click",this._clickExportButton.bind(this)),c.setAttribute("class","oc-download-btn"+(""!==s.chartClass?" "+s.chartClass:"")),c.setAttribute("download",s.exportFilename+".png"),o.appendChild(d),o.appendChild(c)}s.pan&&(o.style.overflow="hidden",a.addEventListener("mousedown",this._onPanStart.bind(this)),a.addEventListener("touchstart",this._onPanStart.bind(this)),document.body.addEventListener("mouseup",this._onPanEnd.bind(this)),document.body.addEventListener("touchend",this._onPanEnd.bind(this))),s.zoom&&(o.addEventListener("wheel",this._onWheeling.bind(this)),o.addEventListener("touchstart",this._onTouchStart.bind(this)),document.body.addEventListener("touchmove",this._onTouchMove.bind(this)),document.body.addEventListener("touchend",this._onTouchEnd.bind(this))),o.appendChild(a)}return _createClass(e,[{key:"_closest",value:function(e,t){return e&&(t(e)&&e!==this.chart?e:this._closest(e.parentNode,t))}},{key:"_closestClass",value:function(e,t,n){return e&&(n(e)&&e.className.indexOf(t)>-1?e:this._closestClass(e.nextElementSibling,t,n))}},{key:"_siblings",value:function(e,t){return Array.from(e.parentNode.children).filter(function(n){return n!==e&&(!t||e.matches(t))})}},{key:"_prevAll",value:function(e,t){for(var n=[],i=e.previousElementSibling;i;)t&&!i.matches(t)||n.push(i),i=i.previousElementSibling;return n}},{key:"_nextAll",value:function(e,t){for(var n=[],i=e.nextElementSibling;i;)t&&!i.matches(t)||n.push(i),i=i.nextElementSibling;return n}},{key:"_isVisible",value:function(e){return null!==e.offsetParent}},{key:"_addClass",value:function(e,t){e.forEach(function(e){t.indexOf(" ")>0?t.split(" ").forEach(function(t){return e.classList.add(t)}):e.classList.add(t)})}},{key:"_removeClass",value:function(e,t){e.forEach(function(e){t.indexOf(" ")>0?t.split(" ").forEach(function(t){return e.classList.remove(t)}):e.classList.remove(t)})}},{key:"_css",value:function(e,t,n){e.forEach(function(e){e.style[t]=n})}},{key:"_removeAttr",value:function(e,t){e.forEach(function(e){e.removeAttribute(t)})}},{key:"_one",value:function(e,t,n,i){var s=function s(r){try{n.call(i,r)}finally{e.removeEventListener(t,s)}};e.addEventListener(t,s)}},{key:"_getDescElements",value:function(e,t){var n=[];return e.forEach(function(e){return n.push.apply(n,_toConsumableArray(e.querySelectorAll(t)))}),n}},{key:"_getJSON",value:function(e){return this.options.callAjax?this.options.callAjax(e):new Promise(function(t,n){function i(){4===this.readyState&&(200===this.status?t(JSON.parse(this.response)):n(new Error(this.statusText)))}var s=new XMLHttpRequest;s.open("GET",e),s.onreadystatechange=i,s.responseType="json",s.setRequestHeader("Content-Type","application/json"),s.send()})}},{key:"_buildJsonDS",value:function(e){var t=this,n={name:e.firstChild.textContent.trim(),relationship:("LI"===e.parentNode.parentNode.nodeName?"1":"0")+(e.parentNode.children.length>1?1:0)+(e.children.length?1:0)};return e.id&&(n.id=e.id),e.querySelector("ul")&&Array.from(e.querySelector("ul").children).forEach(function(e){n.children||(n.children=[]),n.children.push(t._buildJsonDS(e))}),n}},{key:"_attachRel",value:function(e,t){if(e.relationship=t+(e.children&&e.children.length>0?1:0),e.children){var n=!0,i=!1,s=void 0;try{for(var r,a=e.children[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var o=r.value;this._attachRel(o,"1"+(e.children.length>1?1:0))}}catch(e){i=!0,s=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw s}}}return e}},{key:"_repaint",value:function(e){e&&(e.style.offsetWidth=e.offsetWidth)}},{key:"_isInAction",value:function(e){var t=!1,n=e.querySelector(":scope > .edge");return n&&(t=n.className.indexOf("fa-")>-1||n.className.indexOf(this.options.arrowClasses)>-1),t}},{key:"_getNodeState",value:function(e,t,n){var i=this,s=void 0,r={exist:!1,visible:!1};return"parent"===t?(s=this._closest(e,function(e){return e.classList&&e.classList.contains("nodes")}),s&&(r.exist=!0),r.exist&&this._isVisible(s.parentNode.children[0])&&(r.visible=!0)):"children"===t?(s=this._closest(e,function(e){return"TR"===e.nodeName}).nextElementSibling,n&&(s=this._closestClass(s,n,function(e){return"TR"===e.nodeName})),s&&(r.exist=!0),r.exist&&this._isVisible(s)&&(r.visible=!0)):"siblings"===t&&(s=this._siblings(this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode),s.length&&(r.exist=!0),r.exist&&s.some(function(e){return i._isVisible(e)})&&(r.visible=!0)),r}},{key:"getRelatedNodes",value:function(e,t){return"parent"===t?this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children[0].querySelector(".node"):"children"===t?Array.from(this._closest(e,function(e){return"TABLE"===e.nodeName}).lastChild.children).map(function(e){return e.querySelector(".node")}):"siblings"===t?this._siblings(this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode).map(function(e){return e.querySelector(".node")}):[]}},{key:"_switchHorizontalArrow",value:function(e){var t=this.options,n=e.querySelector(".leftEdge"),i=e.querySelector(".rightEdge"),s=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode;if(t.toggleSiblingsResp&&(void 0===t.ajaxURL||this._closest(e,function(e){return e.classList.contains(".nodes")}).dataset.siblingsLoaded)){var r=s.previousElementSibling,a=s.nextElementSibling;r&&(r.classList.contains("hidden")?(n.classList.add("fa-chevron-left"),n.classList.remove("fa-chevron-right")):(n.classList.add("fa-chevron-right"),n.classList.remove("fa-chevron-left"))),a&&(a.classList.contains("hidden")?(i.classList.add("fa-chevron-right"),i.classList.remove("fa-chevron-left")):(i.classList.add("fa-chevron-left"),i.classList.remove("fa-chevron-right")))}else{var o=this._siblings(s),l=!!o.length&&!o.some(function(e){return e.classList.contains("hidden")});n.classList.toggle("fa-chevron-right",l),n.classList.toggle("fa-chevron-left",!l),i.classList.toggle("fa-chevron-left",l),i.classList.toggle("fa-chevron-right",!l)}}},{key:"_hoverNode",value:function(e){var t=e.target,n=this,i=n.options,s=!1,r=t.querySelector(":scope > .topEdge"),a=t.querySelector(":scope > .bottomEdge"),o=t.querySelector(":scope > .leftEdge"),l=[],d={open:"fa-chevron-up",close:"fa-chevron-down"},c={open:"fa-chevron-down",close:"fa-chevron-up"};i.alwaysShowArrows||(i.topEdgeArrow&&i.topEdgeArrow.classes&&(d=i.topEdgeArrow.classes,l=l.concat([d.open,d.close])),i.bottomEdgeArrow&&i.bottomEdgeArrow.classes&&(c=i.bottomEdgeArrow.classes,l=l.concat([c.open,c.close])),"mouseenter"===e.type?(r&&(s=this._getNodeState(t,"parent").visible,r.classList.toggle(d.open,!s),r.classList.toggle(d.close,s)),a&&(s=this._getNodeState(t,"children","lines").visible,a.classList.toggle(c.open,!s),a.classList.toggle(c.close,s)),o&&this._switchHorizontalArrow(t)):Array.from(t.querySelectorAll(":scope > .edge")).forEach(function(e){e.classList.remove("fa-chevron-up","fa-chevron-down","fa-chevron-right","fa-chevron-left"),l.forEach(function(t){e.classList.remove(t)})}))}},{key:"_clickNode",value:function(e){var t=e.currentTarget,n=this.chart.querySelector(".focused");n&&n.classList.remove("focused"),t.classList.add("focused")}},{key:"_buildParentNode",value:function(e,t,n){var i=this,s=document.createElement("table");t.relationship=t.relationship||"001",this._createNode(t,0).then(function(e){var t=i.chart;e.classList.remove("slide-up"),e.classList.add("slide-down");var r=document.createElement("tr"),a=document.createElement("tr"),o=document.createElement("tr"),l=document.createElement("tr");r.setAttribute("class","hidden"),r.innerHTML="<td colspan='2'></td>",s.appendChild(r),a.setAttribute("class","lines hidden"),a.innerHTML="<td colspan='2'><div class='downLine'></div></td>",s.appendChild(a),o.setAttribute("class","lines hidden"),o.innerHTML="<td class='rightLine'>&nbsp;</td><td class='leftLine'>&nbsp;</td>",s.appendChild(o),l.setAttribute("class","nodes"),l.innerHTML="<td colspan='2'></td>",s.appendChild(l),s.querySelector("td").appendChild(e),t.insertBefore(s,t.children[0]),s.children[3].children[0].appendChild(t.lastChild),n()}).catch(function(e){console.error("Failed to create parent node",e)})}},{key:"_switchVerticalArrow",value:function(e){this.options.alwaysShowArrows||(e.classList.toggle("fa-chevron-up"),e.classList.toggle("fa-chevron-down"))}},{key:"showParent",value:function(e){if(!e)return void console.log("no node found");var t=this._prevAll(this._closest(e,function(e){return e.classList.contains("nodes")}));this._removeClass(t,"hidden"),this._addClass(Array(t[0].children).slice(1,-1),"hidden");var n=t.filter(function(e){return e&&!e.className})[0],i=t.filter(function(e){return e&&e.className&&e.className.indexOf("ghostRow")>-1}),s=n.querySelector(".node");JSON.parse(e.getAttribute("data-source")).hideParentSiblings&&this.showSiblings(s),this._one(s,"transitionend",function(){s.classList.remove("slide"),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(":scope > .topEdge"))},this),this._repaint(s),this._removeClass(i,"active"),s.classList.add("slide"),s.classList.remove("slide-down"),s&&this.options.hideOnlyParent&&this.showLines(s)}},{key:"showSiblings",value:function(e,t){var n=this;JSON.parse(e.getAttribute("data-source")).hideParentSiblings;var i=[],s=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode;i=t?"left"===t?this._prevAll(s):this._nextAll(s):this._siblings(s),this._removeClass(i,"hidden");var r=this.options.additionalClasses+"-"+(i.length+1);this._addClass([this.chartContainer],r);var a=this._prevAll(this._closest(e,function(e){return e.classList.contains("nodes")}));if(s=Array.from(a[0].querySelectorAll(":scope > .hidden")),t?this._removeClass(s.slice(0,2*i.length),"hidden"):this._removeClass(s,"hidden"),!this._getNodeState(e,"parent").visible){this._removeClass(a,"hidden");var o=a[2].querySelector(".node");this._one(o,"transitionend",function(e){e.target.classList.remove("slide")},this),this._repaint(o),o.classList.add("slide"),o.classList.remove("slide-down")}i.forEach(function(e){Array.from(e.querySelectorAll(".node")).forEach(function(e){n._isVisible(e)&&(e.classList.add("slide"),e.classList.remove("slide-left","slide-right"))})}),i[0]&&this._one(i[0].querySelector(".slide"),"transitionend",function(){var t=this;i.forEach(function(e){t._removeClass(Array.from(e.querySelectorAll(".slide")),"slide")}),this._isInAction(e)&&(this._switchHorizontalArrow(e),e.querySelector(".topEdge").classList.remove("fa-chevron-up"),e.querySelector(".topEdge").classList.add("fa-chevron-down"))},this)}},{key:"hideSiblings",value:function(e,t){var n=this,i=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode,s=this._siblings(i);s.forEach(function(e){e.querySelector(".spinner")&&(n.chart.dataset.inAjax=!1)});var r=this.options.additionalClasses+"-"+(s.length+1);if(this._removeClass([this.chartContainer],r),!t||t&&"left"===t){this._prevAll(i).forEach(function(e){Array.from(e.querySelectorAll(".node")).forEach(function(e){n._isVisible(e)&&e.classList.add("slide","slide-right")})})}if(!t||t&&"left"!==t){this._nextAll(i).forEach(function(e){Array.from(e.querySelectorAll(".node")).forEach(function(e){n._isVisible(e)&&e.classList.add("slide","slide-left")})})}var a=[];this._siblings(i).forEach(function(e){Array.prototype.push.apply(a,Array.from(e.querySelectorAll(".slide")))});var o=[],l=!0,d=!1,c=void 0;try{for(var h,u=a[Symbol.iterator]();!(l=(h=u.next()).done);l=!0){var f=h.value,p=this._closest(f,function(e){return e.classList.contains("nodes")}).previousElementSibling;o.push(p),o.push(p.previousElementSibling)}}catch(e){d=!0,c=e}finally{try{!l&&u.return&&u.return()}finally{if(d)throw c}}o=[].concat(_toConsumableArray(new Set(o))),this.options.animateLines&&o.forEach(function(e){e.style.visibility="hidden"}),a[0]&&this._one(a[0],"transitionend",function(n){var s=this;this.options.animateLines&&o.forEach(function(e){e.removeAttribute("style")});var r=[];r=t?"left"===t?this._prevAll(i,":not(.hidden)"):this._nextAll(i,":not(.hidden)"):this._siblings(i),this._removeClass(a,"slide"),r.forEach(function(e){Array.from(e.querySelectorAll(".node")).slice(1).forEach(function(e){s._isVisible(e)&&(e.classList.remove("slide-left","slide-right"),e.classList.add("slide-up"))})}),r.forEach(function(e){s._addClass(Array.from(e.querySelectorAll(".lines")),"hidden"),s._addClass(Array.from(e.querySelectorAll(".nodes")),"hidden"),s._addClass(Array.from(e.querySelectorAll(".verticalNodes")),"hidden")}),this._addClass(r,"hidden"),this._isInAction(e)&&this._switchHorizontalArrow(e)},this)}},{key:"hideParent",value:function(e){var t=JSON.parse(e.getAttribute("data-source")),n=this.options,i=Array.from(this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children).slice(0,4);i[0].querySelector(".spinner")&&(this.chart.dataset.inAjax=!1),this._getNodeState(e,"siblings").visible&&n.hideSiblings&&this.hideSiblings(e);var s=i.filter(function(e){return e&&e.className&&e.className.indexOf("lines")>-1}),r=i[0].querySelector(".node"),a=this._getNodeState(r,"parent").visible;t.hideParentSiblings&&this.hideSiblings(r),r&&this._isVisible(r)&&(r.classList.add("slide","slide-down"),this._one(r,"transitionend",function(){r.classList.remove("slide"),this._removeAttr(s,"style"),r&&this.options.hideOnlyParent?this._addClass([i[0]],"hidden"):this._addClass(i,"hidden")},this)),r&&a&&!this.options.hideOnlyParent&&this.hideParent(r),r&&this.options.hideOnlyParent&&!t.showLines&&this.hideLines(r),this.options.hideOnlyParent&&this._addClass(s,"hidden")}},{key:"hideLines",value:function(e){var t=Array.from(this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children),n=t.filter(function(e){return e&&e.className&&e.className.indexOf("lines")>-1});this._addClass(n,"hidden")}},{key:"showLines",value:function(e){var t=Array.from(this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children),n=t.filter(function(e){return e&&e.className&&e.className.indexOf("lines")>-1});this._removeClass(n,"hidden")}},{key:"addParent",value:function(e,t){var n=this;this._buildParentNode(e,t,function(){if(!e.querySelector(":scope > .topEdge")){var t=document.createElement("i");t.setAttribute("class","edge verticalEdge topEdge fa"),e.appendChild(t)}n.showParent(e)})}},{key:"_startLoading",value:function(e,t){var n=this.options,i=this.chart;if(void 0!==i.dataset.inAjax&&"true"===i.dataset.inAjax)return!1;e.classList.add("hidden");var s=document.createElement("i");s.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),n.loader&&(s=n.loader()),t.appendChild(s),this._addClass(Array.from(t.querySelectorAll(":scope > *:not(.spinner)")),"hazy"),i.dataset.inAjax=!0;var r=this.chartContainer.querySelector(".oc-export-btn"+(""!==n.chartClass?"."+n.chartClass:""));return r&&(r.disabled=!0),!0}},{key:"_endLoading",value:function(e,t){var n=this.options;e.classList.remove("hidden"),t.querySelector(":scope > .spinner").remove(),this._removeClass(Array.from(t.querySelectorAll(":scope > .hazy")),"hazy"),this.chart.dataset.inAjax=!1;var i=this.chartContainer.querySelector(".oc-export-btn"+(""!==n.chartClass?"."+n.chartClass:""));i&&(i.disabled=!1)}},{key:"_clickTopEdge",value:function(e){e.stopPropagation();var t=this,n=e.target,i=n.parentNode,s=this._getNodeState(i,"parent"),r=this.options;if(JSON.parse(i.getAttribute("data-source")).bidirectional)s.visible?(this.hideParent(i),this._one(parent,"transitionend",function(){this._isInAction(i)&&this._switchVerticalArrow(n)},this),this.hideGhost()):(this.hideSiblingParent(i),this.showParent(i));else if(s.exist){var a=this._closest(i,function(e){return e.classList.contains("nodes")}),o=a.parentNode.firstChild.querySelector(".node");if(o.classList.contains("slide"))return;s.visible?(this.hideParent(i),this._one(o,"transitionend",function(){this._isInAction(i)&&(this._switchVerticalArrow(n),this._switchHorizontalArrow(i))},this)):this.showParent(i)}else{var l=n.parentNode.id;this._startLoading(n,i)&&this._getJSON("function"==typeof r.ajaxURL.parent?r.ajaxURL.parent(i.dataset.source):r.ajaxURL.parent+l).then(function(e){"true"===t.chart.dataset.inAjax&&Object.keys(e).length&&t.addParent(i,e)}).catch(function(e){console.error("Failed to get parent node data.",e)}).finally(function(){t._endLoading(n,i)})}}},{key:"hideChildren",value:function(e){var t=this,n=this._nextAll(e.parentNode.parentNode),i=n[n.length-1],s=[];i.querySelector(".spinner")&&(this.chart.dataset.inAjax=!1);var r=Array.from(i.querySelectorAll(".node")).filter(function(e){return t._isVisible(e)}),a=i.classList.contains("verticalNodes");a||(r.forEach(function(e){Array.prototype.push.apply(s,t._prevAll(t._closest(e,function(e){return e.classList.contains("nodes")}),".lines"))}),s=[].concat(_toConsumableArray(new Set(s))),this._css(s,"visibility","hidden")),this._one(r[0],"transitionend",function(o){this._removeClass(r,"slide"),a?t._addClass(n,"hidden"):(s.forEach(function(e){e.removeAttribute("style"),e.classList.add("hidden"),e.parentNode.lastChild.classList.add("hidden")}),this._addClass(Array.from(i.querySelectorAll(".verticalNodes")),"hidden")),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(".bottomEdge"))},this),this._addClass(r,"slide slide-up")}},{key:"showChildren",value:function(e){var t=this,n=this,i=this._nextAll(e.parentNode.parentNode),s=[],r=i.filter(function(e){return e&&e.className&&e.className.indexOf("nodes")>-1});this._removeClass(i,"hidden"),i.some(function(e){return e.classList.contains("verticalNodes")})?i.forEach(function(e){Array.prototype.push.apply(s,Array.from(e.querySelectorAll(".node")).filter(function(e){return n._isVisible(e)}))}):Array.from(r[0].children).forEach(function(e){Array.prototype.push.apply(s,Array.from(e.querySelector("tr").querySelectorAll(".node")).filter(function(e){return n._isVisible(e)}))}),this._repaint(s[0]),this._one(s[0],"transitionend",function(n){t._removeClass(s,"slide"),t._isInAction(e)&&t._switchVerticalArrow(e.querySelector(".bottomEdge"))},this),this._addClass(s,"slide"),this._removeClass(s,"slide-up")}},{key:"_buildChildNode",value:function(e,t,n){var i=t.children||t.siblings;e.querySelector("td").setAttribute("colSpan",2*i.length),this.buildHorizontalHierarchy(e,{children:i},0,n)}},{key:"addChildren",value:function(e,t){var n=this,i=this.options,s=0;this.chart.dataset.inEdit="addChildren",this._buildChildNode.call(this,this._closest(e,function(e){return"TABLE"===e.nodeName}),t,function(){if(++s===t.children.length){if(!e.querySelector(".bottomEdge")){var r=document.createElement("i");r.setAttribute("class","edge verticalEdge bottomEdge fa"),e.appendChild(r)}if(!e.querySelector(".symbol")){var a=document.createElement("i");a.setAttribute("class","fa "+i.parentNodeSymbol+" symbol"),e.querySelector(":scope > .title").appendChild(a)}n.showChildren(e),n.chart.dataset.inEdit=""}})}},{key:"_clickBottomEdge",value:function(e){var t=this;e.stopPropagation();var n=this,i=this.options,s=e.target,r=s.parentNode,a=this._getNodeState(r,"children","lines"),o=JSON.parse(r.getAttribute("data-source")),l=o.toggleLevel?Number(o.toggleLevel)+1:null,d="open-level-"+l;if(a.exist){var c=this._closest(r,function(e){return"TR"===e.nodeName}).parentNode.lastChild;if(Array.from(c.querySelectorAll(".node")).some(function(e){return t._isVisible(e)&&e.classList.contains("slide")}))return;a.visible?(this.hideChildren(r),l&&this._removeClass([this.chartContainer],d)):(this.showChildren(r),l&&this._addClass([this.chartContainer],d))}else{var h=s.parentNode.id;if(this._startLoading(s,r)){if("function"==typeof i.loadChildren)return void i.loadChildren(function(e){"true"===n.chart.dataset.inAjax&&e.children.length&&(e.children.map(function(e){e.children&&e.children.length&&(e.relationship="001")}),n.addChildren(r,e)),n._endLoading(s,r)});this._getJSON("function"==typeof i.ajaxURL.children?i.ajaxURL.children(r.dataset.source):i.ajaxURL.children+h).then(function(e){"true"===n.chart.dataset.inAjax&&e.children.length&&n.addChildren(r,e)}).catch(function(e){console.error("Failed to get children nodes data",e)}).finally(function(){n._endLoading(s,r)})}}}},{key:"_complementLine",value:function(e,t,n){var i=e.parentNode.parentNode.children;i[0].children[0].setAttribute("colspan",2*t),i[1].children[0].setAttribute("colspan",2*t);for(var s=0;s<n;s++){var r=document.createElement("td"),a=document.createElement("td");r.setAttribute("class","rightLine topLine"),r.innerHTML="&nbsp;",i[2].insertBefore(r,i[2].children[1]),a.setAttribute("class","leftLine topLine"),a.innerHTML="&nbsp;",i[2].insertBefore(a,i[2].children[1])}}},{key:"_buildSiblingNode",value:function(e,t,n){var i=this,s=this,r=t.siblings?t.siblings.length:t.children.length,a="TD"===e.parentNode.nodeName?this._closest(e,function(e){return"TR"===e.nodeName}).children.length:1,o=a+r,l=o>1?Math.floor(o/2-1):0;if("TD"===e.parentNode.nodeName){var d=this._prevAll(e.parentNode.parentNode);d[0].remove(),d[1].remove();var c=0;s._buildChildNode.call(s,s._closest(e.parentNode,function(e){return"TABLE"===e.nodeName}),t,function(){if(++c===r){var t=Array.from(s._closest(e.parentNode,function(e){return"TABLE"===e.nodeName}).lastChild.children);if(a>1){var i=e.parentNode.parentNode;Array.from(i.children).forEach(function(e){t[0].parentNode.insertBefore(e,t[0])}),i.remove(),s._complementLine(t[0],o,a),s._addClass(t,"hidden"),t.forEach(function(e){s._addClass(e.querySelectorAll(".node"),"slide-left")})}else{var d=e.parentNode.parentNode;t[l].parentNode.insertBefore(e.parentNode,t[l+1]),d.remove(),s._complementLine(t[l],o,1),s._addClass(t,"hidden"),s._addClass(s._getDescElements(t.slice(0,l+1),".node"),"slide-right"),s._addClass(s._getDescElements(t.slice(l+1),".node"),"slide-left")}n()}})}else{var h=0;s.buildHierarchy.call(s,s.chart,t,0,function(){if(++h===o){var t=e.nextElementSibling.children[3].children[l],r=document.createElement("td");r.setAttribute("colspan",2),r.appendChild(e),t.parentNode.insertBefore(r,t.nextElementSibling),s._complementLine(t,o,1);var a=s._closest(e,function(e){return e.classList&&e.classList.contains("nodes")}).parentNode.children[0];a.classList.add("hidden"),s._addClass(Array.from(a.querySelectorAll(".node")),"slide-down");var d=i._siblings(e.parentNode);s._addClass(d,"hidden"),s._addClass(s._getDescElements(d.slice(0,l),".node"),"slide-right"),s._addClass(s._getDescElements(d.slice(l),".node"),"slide-left"),n()}})}}},{key:"addSiblings",value:function(e,t){var n=this;this.chart.dataset.inEdit="addSiblings",this._buildSiblingNode.call(this,this._closest(e,function(e){return"TABLE"===e.nodeName}),t,function(){if(n._closest(e,function(e){return e.classList&&e.classList.contains("nodes")}).dataset.siblingsLoaded=!0,!e.querySelector(".leftEdge")){var t=document.createElement("i"),i=document.createElement("i");t.setAttribute("class","edge horizontalEdge rightEdge fa"),e.appendChild(t),i.setAttribute("class","edge horizontalEdge leftEdge fa"),e.appendChild(i)}n.showSiblings(e),n.chart.dataset.inEdit=""})}},{key:"removeNodes",value:function(e){var t=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode,n=this._siblings(t.parentNode);"TD"===t.nodeName?this._getNodeState(e,"siblings").exist?(n[2].querySelector(".topLine").nextElementSibling.remove(),n[2].querySelector(".topLine").remove(),n[0].children[0].setAttribute("colspan",n[2].children.length),n[1].children[0].setAttribute("colspan",n[2].children.length),t.remove()):(n[0].children[0].removeAttribute("colspan"),n[0].querySelector(".bottomEdge").remove(),this._siblings(n[0]).forEach(function(e){return e.remove()})):Array.from(t.parentNode.children).forEach(function(e){return e.remove()})}},{key:"_clickHorizontalEdge",value:function(e){var t=this;e.stopPropagation();var n=this,i=this.options,s=e.target,r=s.parentNode,a=this._getNodeState(r,"siblings");if(a.exist){var o=this._closest(r,function(e){return"TABLE"===e.nodeName}).parentNode;if(this._siblings(o).some(function(e){var n=e.querySelector(".node");return t._isVisible(n)&&n.classList.contains("slide")}))return;if(i.toggleSiblingsResp){var l=this._closest(r,function(e){return"TABLE"===e.nodeName}).parentNode.previousElementSibling,d=this._closest(r,function(e){return"TABLE"===e.nodeName}).parentNode.nextElementSibling;s.classList.contains("leftEdge")?l.classList.contains("hidden")?this.showSiblings(r,"left"):this.hideSiblings(r,"left"):d.classList.contains("hidden")?this.showSiblings(r,"right"):this.hideSiblings(r,"right")}else a.visible?this.hideSiblings(r):this.showSiblings(r)}else{var c=s.parentNode.id,h=this._getNodeState(r,"parent").exist?"function"==typeof i.ajaxURL.siblings?i.ajaxURL.siblings(JSON.parse(r.dataset.source)):i.ajaxURL.siblings+c:"function"==typeof i.ajaxURL.families?i.ajaxURL.families(JSON.parse(r.dataset.source)):i.ajaxURL.families+c;this._startLoading(s,r)&&this._getJSON(h).then(function(e){"true"===n.chart.dataset.inAjax&&(e.siblings||e.children)&&n.addSiblings(r,e)}).catch(function(e){console.error("Failed to get sibling nodes data",e)}).finally(function(){n._endLoading(s,r)})}}},{key:"_clickToggleButton",value:function(e){var t=this,n=e.target,i=n.parentNode.nextElementSibling,s=Array.from(i.querySelectorAll(".node")),r=Array.from(i.children).map(function(e){return e.querySelector(".node")});r.some(function(e){return e.classList.contains("slide")})||(n.classList.toggle("fa-plus-square"),n.classList.toggle("fa-minus-square"),s[0].classList.contains("slide-up")?(i.classList.remove("hidden"),this._repaint(r[0]),this._addClass(r,"slide"),this._removeClass(r,"slide-up"),this._one(r[0],"transitionend",function(){t._removeClass(r,"slide")})):(this._addClass(s,"slide slide-up"),this._one(s[0],"transitionend",function(){t._removeClass(s,"slide"),s.forEach(function(e){t._closest(e,function(e){return"UL"===e.nodeName}).classList.add("hidden")})}),s.forEach(function(e){var n=Array.from(e.querySelectorAll(".toggleBtn"));t._removeClass(n,"fa-minus-square"),t._addClass(n,"fa-plus-square")})))}},{key:"_dispatchClickEvent",value:function(e){var t=e.target.classList;t.contains("topEdge")?this._clickTopEdge(e):t.contains("rightEdge")||t.contains("leftEdge")?this._clickHorizontalEdge(e):t.contains("bottomEdge")?this._clickBottomEdge(e):t.contains("toggleBtn")?this._clickToggleButton(e):this._clickNode(e)}},{key:"_onDragStart",value:function(e){var t=e.target,n=this.options,i=/firefox/.test(window.navigator.userAgent.toLowerCase());if(i&&e.dataTransfer.setData("text/html","hack for firefox"),this.chart.style.transform){var s=void 0,r=void 0;document.querySelector(".ghost-node")?(s=this.chart.querySelector(":scope > .ghost-node"),r=s.children[0]):(s=document.createElementNS("http://www.w3.org/2000/svg","svg"),s.classList.add("ghost-node"),r=document.createElementNS("http://www.w3.org/2000/svg","rect"),s.appendChild(r),this.chart.appendChild(s));var a=this.chart.style.transform.split(","),o=Math.abs(window.parseFloat("t2b"===n.direction||"b2t"===n.direction?a[0].slice(a[0].indexOf("(")+1):a[1]));s.setAttribute("width",t.offsetWidth),s.setAttribute("height",t.offsetHeight),r.setAttribute("x",5*o),r.setAttribute("y",5*o),r.setAttribute("width",120*o),r.setAttribute("height",40*o),r.setAttribute("rx",4*o),r.setAttribute("ry",4*o),r.setAttribute("stroke-width",1*o);var l=e.offsetX*o,d=e.offsetY*o;if("l2r"===n.direction?(l=e.offsetY*o,d=e.offsetX*o):"r2l"===n.direction?(l=t.offsetWidth-e.offsetY*o,d=e.offsetX*o):"b2t"===n.direction&&(l=t.offsetWidth-e.offsetX*o,d=t.offsetHeight-e.offsetY*o),i){var c=document.createElement("img");c.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(s),e.dataTransfer.setDragImage(c,l,d),r.setAttribute("fill","rgb(255, 255, 255)"),r.setAttribute("stroke","rgb(191, 0, 0)")}else e.dataTransfer.setDragImage(s,l,d)}var h=e.target,u=this._closest(h,function(e){return e.classList&&e.classList.contains("nodes")}).parentNode.children[0].querySelector(".node"),f=Array.from(this._closest(h,function(e){return"TABLE"===e.nodeName}).querySelectorAll(".node"));this.dragged=h,Array.from(this.chart.querySelectorAll(".node")).forEach(function(e){f.includes(e)||(n.dropCriteria?n.dropCriteria(h,u,e)&&e.classList.add("allowedDrop"):e.classList.add("allowedDrop"))})}},{key:"_onDragOver",value:function(e){e.preventDefault(),e.currentTarget.classList.contains("allowedDrop")||(e.dataTransfer.dropEffect="none")}},{key:"_onDragEnd",value:function(e){Array.from(this.chart.querySelectorAll(".allowedDrop")).forEach(function(e){e.classList.remove("allowedDrop")})}},{key:"_onDrop",value:function(e){var t=e.currentTarget,n=this.chart,i=this.dragged,s=this._closest(i,function(e){return e.classList&&e.classList.contains("nodes")}).parentNode.children[0].children[0];if(this._removeClass(Array.from(n.querySelectorAll(".allowedDrop")),"allowedDrop"),t.parentNode.parentNode.nextElementSibling){var r=window.parseInt(t.parentNode.colSpan)+2;if(t.parentNode.setAttribute("colspan",r),t.parentNode.parentNode.nextElementSibling.children[0].setAttribute("colspan",r),!i.querySelector(".horizontalEdge")){var a=document.createElement("i"),o=document.createElement("i");a.setAttribute("class","edge horizontalEdge rightEdge fa"),i.appendChild(a),o.setAttribute("class","edge horizontalEdge leftEdge fa"),i.appendChild(o)}var l=t.parentNode.parentNode.nextElementSibling.nextElementSibling,d=document.createElement("td"),c=document.createElement("td");d.setAttribute("class","leftLine topLine"),
d.innerHTML="&nbsp;",l.insertBefore(d,l.children[1]),c.setAttribute("class","rightLine topLine"),c.innerHTML="&nbsp;",l.insertBefore(c,l.children[2]),l.nextElementSibling.appendChild(this._closest(i,function(e){return"TABLE"===e.nodeName}).parentNode);var h=this._siblings(this._closest(i,function(e){return"TABLE"===e.nodeName}).parentNode).map(function(e){return e.querySelector(".node")});if(1===h.length){var u=document.createElement("i"),f=document.createElement("i");u.setAttribute("class","edge horizontalEdge rightEdge fa"),h[0].appendChild(u),f.setAttribute("class","edge horizontalEdge leftEdge fa"),h[0].appendChild(f)}}else{var p=document.createElement("i");p.setAttribute("class","edge verticalEdge bottomEdge fa"),t.appendChild(p),t.parentNode.setAttribute("colspan",2);var v=this._closest(t,function(e){return"TABLE"===e.nodeName}),g=document.createElement("tr"),m=document.createElement("tr"),b=document.createElement("tr");g.setAttribute("class","lines"),g.innerHTML='<td colspan="2"><div class="downLine"></div></td>',v.appendChild(g),m.setAttribute("class","lines"),m.innerHTML='<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>',v.appendChild(m),b.setAttribute("class","nodes"),v.appendChild(b),Array.from(i.querySelectorAll(".horizontalEdge")).forEach(function(e){i.removeChild(e)});var y=this._closest(i,function(e){return"TABLE"===e.nodeName}).parentNode;b.appendChild(y)}var _=window.parseInt(s.colSpan);if(_>2){s.setAttribute("colspan",_-2),s.parentNode.nextElementSibling.children[0].setAttribute("colspan",_-2);var E=s.parentNode.nextElementSibling.nextElementSibling;E.children[1].remove(),E.children[1].remove();var L=Array.from(s.parentNode.parentNode.children[3].children).map(function(e){return e.querySelector(".node")});1===L.length&&(L[0].querySelector(".leftEdge").remove(),L[0].querySelector(".rightEdge").remove())}else s.removeAttribute("colspan"),s.querySelector(".node").removeChild(s.querySelector(".bottomEdge")),Array.from(s.parentNode.parentNode.children).slice(1).forEach(function(e){return e.remove()});var A=new CustomEvent("nodedropped.orgchart",{detail:{draggedNode:i,dragZone:s.children[0],dropZone:t}});n.dispatchEvent(A)}},{key:"_createNode",value:function(e,t){var n=this,i=this.options;return new Promise(function(s,r){if(e.children){var a=!0,o=!1,l=void 0;try{for(var d,c=e.children[Symbol.iterator]();!(a=(d=c.next()).done);a=!0){d.value.parentId=e.id}}catch(e){o=!0,l=e}finally{try{!a&&c.return&&c.return()}finally{if(o)throw l}}}var h=document.createElement("div");delete e.children,h.dataset.source=JSON.stringify(e),e[i.nodeId]&&(h.id=e[i.nodeId]);var u=n.chart.dataset.inEdit,f=e.hideParentSiblings?" hide-parent-siblings":"",p=void 0;p=u?"addChildren"===u?" slide-up":"":t>=i.depth?" slide-up":"",h.setAttribute("class","node "+(e.className||"")+p+f),i.draggable&&h.setAttribute("draggable",!0),e.parentId&&h.setAttribute("data-parent",e.parentId),h.innerHTML='\n        <div class="title">'+e[i.nodeTitle]+"</div>\n        "+(i.nodeContent?'<div class="content">'+e[i.nodeContent]+"</div>":"")+"\n      ";var v=e.relationship||"",g=i.verticalDepth&&t+2>i.verticalDepth,m=!g||i.verticalDepthEnd&&t+2>i.verticalDepthEnd;if(!g||m||e.disableDownward){var b={open:"",close:""},y={open:"",close:""};if(i.alwaysShowArrows&&(b={open:"fa-chevron-up",close:"fa-chevron-down"},y={open:"fa-chevron-down",close:"fa-chevron-up"}),i.topEdgeArrow&&i.topEdgeArrow.classes&&(b=i.topEdgeArrow.classes),i.bottomEdgeArrow&&i.bottomEdgeArrow.classes&&(y=i.bottomEdgeArrow.classes),Number(v.substr(0,1))&&e.bidirectional){var _=document.createElement("i");_.setAttribute("class","edge verticalEdge topEdge fa "+b.open),h.appendChild(_)}if(Number(v.substr(1,1)&&i.toggleSiblingsResp)){var E=document.createElement("i"),L=document.createElement("i");E.setAttribute("class","edge horizontalEdge rightEdge fa"),h.appendChild(E),L.setAttribute("class","edge horizontalEdge leftEdge fa"),h.appendChild(L)}if(Number(v.substr(2,1))&&!e.disableDownward){var A=document.createElement("i"),S=document.createElement("i"),N=h.querySelector(":scope > .title");A.setAttribute("class","edge verticalEdge bottomEdge fa "+y.open),h.appendChild(A),S.setAttribute("class","fa "+i.parentNodeSymbol+" symbol"),N.insertBefore(S,N.children[0])}}else if(t+1>=i.verticalDepth&&Number(v.substr(2,1))){var C=document.createElement("i"),w=t+1>=i.depth?"plus":"minus";C.setAttribute("class","toggleBtn fa fa-"+w+"-square"),h.appendChild(C)}h.addEventListener("mouseenter",n._hoverNode.bind(n)),h.addEventListener("mouseleave",n._hoverNode.bind(n)),h.addEventListener("click",n._dispatchClickEvent.bind(n)),i.draggable&&(h.addEventListener("dragstart",n._onDragStart.bind(n)),h.addEventListener("dragover",n._onDragOver.bind(n)),h.addEventListener("dragend",n._onDragEnd.bind(n)),h.addEventListener("drop",n._onDrop.bind(n))),i.createNode&&i.createNode(h,e),s(h)})}},{key:"buildHierarchy",value:function(e,t,n,i){var s=this,r=this.options,a=void 0,o=t.children,l=r.verticalDepth&&n+1>=r.verticalDepth,d=!l||r.verticalDepthEnd&&n+1>=r.verticalDepthEnd;if(Object.keys(t).length>1&&(a=d?document.createElement("table"):e,l&&!d||e.appendChild(a),this._createNode(t,n).then(function(e){if(l&&!d){var t=n+1>=r.hiddenRow?"hidden":"";if("TABLE"===a.tagName){var s=document.createElement("tr");s.setAttribute("class",t),s.innerHTML="\n            <td "+(o?"colspan='"+2*o.length+"'":"")+">\n            </td>\n            ",s.children[0].appendChild(e),a.insertBefore(s,a.children[0]?a.children[0]:null)}else a.setAttribute("class",t),a.insertBefore(e,a.firstChild)}else{var c=document.createElement("tr");c.innerHTML="\n            <td "+(o?"colspan='"+2*o.length+"'":"")+">\n            </td>\n          ",c.children[0].appendChild(e),a.insertBefore(c,a.children[0]?a.children[0]:null)}i&&i()}).catch(function(e){console.error("Failed to creat node",e)})),o){1===Object.keys(t).length&&(a=e);var c=void 0,h="",u=r.verticalDepth&&n+2>=r.verticalDepth,f=!u||r.verticalDepthEnd&&n+2>=r.verticalDepthEnd,p=s.chart.dataset.inEdit;if(c=p?"addSiblings"===p?"":" hidden":n+1>=r.depth?" hidden":"",l&&!d&&(h=n+1>=r.hiddenRow?" hidden":"",a=a.appendChild(document.createElement("table"))),!u||f){var v=document.createElement("tr"),g=document.createElement("tr");g.setAttribute("class","ghostRow"),g.innerHTML="\n          <td colspan='"+2*o.length+"'>\n            <div class='ghostLine'></div>\n          </td>\n        ",this.ghostLines.push(g),a.appendChild(g),v.setAttribute("class","lines"+c+h),v.innerHTML="\n          <td colspan='"+2*o.length+"'>\n            <div class='downLine'></div>\n          </td>\n        ",a.appendChild(v)}var m=document.createElement("tr");m.setAttribute("class","lines"+c+h),m.innerHTML="\n        <td class='rightLine'>&nbsp;</td>\n        "+o.slice(1).map(function(){return"\n          <td class='leftLine topLine'>&nbsp;</td>\n          <td class='rightLine topLine'>&nbsp;</td>\n          "}).join("")+"\n        <td class='leftLine'>&nbsp;</td>\n      ";var b=void 0;if(u&&!f)if(b=document.createElement("ul"),c&&b.classList.add(c.trim()),n+2===r.verticalDepth){var y=document.createElement("tr");y.setAttribute("class","verticalNodes"+c),y.innerHTML="<td></td>",y.firstChild.appendChild(b),a.appendChild(y)}else a.appendChild(b);else b=document.createElement("tr"),b.setAttribute("class","nodes"+c),a.appendChild(m),a.appendChild(b);o.forEach(function(e){var t=void 0;u&&!f?t=document.createElement("li"):(t=document.createElement("td"),t.setAttribute("colspan",2)),b.appendChild(t),s.buildHierarchy(t,e,n+1,i)})}}},{key:"buildHorizontalHierarchy",value:function(e,t,n,i){var s=this,r=void 0,a=t.children;if(Object.keys(t).length>1&&(r=document.createElement("table"),e.appendChild(r),this._createNode(t,n).then(function(e){var t=document.createElement("tr");t.innerHTML="\n          <td "+(a?"colspan='"+2*a.length+"'":"")+">\n          </td>\n        ",t.children[0].appendChild(e),r.insertBefore(t,r.children[0]?r.children[0]:null),i&&i()}).catch(function(e){console.error("Failed to creat node",e)})),a){1===Object.keys(t).length&&(r=e);var o=void 0,l=s.chart.dataset.inEdit;l&&(o="addSiblings"===l?"":" hidden");var d=document.createElement("tr"),c=document.createElement("tr");c.setAttribute("class","ghostRow"),c.innerHTML="\n        <td colspan='"+2*a.length+"'>\n          <div class='ghostLine'></div>\n        </td>\n      ",this.ghostLines.push(c),r.appendChild(c),d.setAttribute("class","lines"+o),d.innerHTML="\n        <td colspan='"+2*a.length+"'>\n          <div class='downLine'></div>\n        </td>\n      ",r.appendChild(d);var h=document.createElement("tr");h.setAttribute("class","lines"+o),h.innerHTML="\n        <td class='rightLine'>&nbsp;</td>\n        "+a.slice(1).map(function(){return"\n          <td class='leftLine topLine'>&nbsp;</td>\n          <td class='rightLine topLine'>&nbsp;</td>\n          "}).join("")+"\n        <td class='leftLine'>&nbsp;</td>\n      ";var u=void 0;u=document.createElement("tr"),u.setAttribute("class","nodes"+o),r.appendChild(h),r.appendChild(u),a.forEach(function(e){var t=void 0;t=document.createElement("td"),t.setAttribute("colspan",2),u.appendChild(t),s.buildHorizontalHierarchy(t,e,n+1,i)})}}},{key:"_clickChart",value:function(e){!this._closest(e.target,function(e){return e.classList&&e.classList.contains("node")})&&this.chart.querySelector(".node.focused")&&this.chart.querySelector(".node.focused").classList.remove("focused")}},{key:"_clickExportButton",value:function(){var e=this.options,t=this.chartContainer,n=t.querySelector(":scope > .mask"),i=t.querySelector(".orgchart:not(.hidden)"),s="l2r"===e.direction||"r2l"===e.direction;n?n.classList.remove("hidden"):(n=document.createElement("div"),n.setAttribute("class","mask"),n.innerHTML="<i class='fa fa-circle-o-notch fa-spin spinner'></i>",t.appendChild(n)),t.classList.add("canvasContainer"),window.html2canvas(i,{width:s?i.clientHeight:i.clientWidth,height:s?i.clientWidth:i.clientHeight,onclone:function(e){var t=e.querySelector(".canvasContainer");t.style.overflow="visible",t.querySelector(".orgchart:not(.hidden)").transform=""}}).then(function(e){var n=t.querySelector(".oc-download-btn");t.querySelector(".mask").classList.add("hidden"),n.setAttribute("href",e.toDataURL()),n.click()}).catch(function(e){console.error("Failed to export the curent orgchart!",e)}).finally(function(){t.classList.remove("canvasContainer")})}},{key:"_loopChart",value:function(e){var t=this,n={id:e.querySelector(".node").id};return e.children[3]&&Array.from(e.children[3].children).forEach(function(e){n.children||(n.children=[]),n.children.push(t._loopChart(e.firstChild))}),n}},{key:"getHierarchy",value:function(){return this.chart.querySelector(".node").id?this._loopChart(this.chart.querySelector("table")):"Error: Nodes of orghcart to be exported must have id attribute!"}},{key:"_onPanStart",value:function(e){var t=e.currentTarget;if(this._closest(e.target,function(e){return e.classList&&e.classList.contains("node")})||e.touches&&e.touches.length>1)return void(t.dataset.panning=!1);t.style.cursor="move",t.dataset.panning=!0;var n=0,i=0,s=window.getComputedStyle(t).transform;if("none"!==s){var r=s.split(",");s.includes("3d")?(n=Number.parseInt(r[12],10),i=Number.parseInt(r[13],10)):(n=Number.parseInt(r[4],10),i=Number.parseInt(r[5],10))}var a=0,o=0;if(e.targetTouches){if(1===e.targetTouches.length)a=e.targetTouches[0].pageX-n,o=e.targetTouches[0].pageY-i;else if(e.targetTouches.length>1)return}else a=e.pageX-n,o=e.pageY-i;t.dataset.panStart=JSON.stringify({startX:a,startY:o}),t.addEventListener("mousemove",this._onPanning.bind(this)),t.addEventListener("touchmove",this._onPanning.bind(this))}},{key:"_onPanning",value:function(e){var t=e.currentTarget;if("false"!==t.dataset.panning){var n=0,i=0,s=JSON.parse(t.dataset.panStart),r=s.startX,a=s.startY;if(e.targetTouches){if(1===e.targetTouches.length)n=e.targetTouches[0].pageX-r,i=e.targetTouches[0].pageY-a;else if(e.targetTouches.length>1)return}else n=e.pageX-r,i=e.pageY-a;var o=window.getComputedStyle(t).transform;if("none"===o)o.includes("3d")?t.style.transform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+n+", "+i+", 0, 1)":t.style.transform="matrix(1, 0, 0, 1, "+n+", "+i+")";else{var l=o.split(",");o.includes("3d")?(l[12]=n,l[13]=i):(l[4]=n,l[5]=i+")"),t.style.transform=l.join(",")}}}},{key:"_onPanEnd",value:function(e){var t=this.chart;"true"===t.dataset.panning&&(t.dataset.panning=!1,t.style.cursor="default",document.body.removeEventListener("mousemove",this._onPanning),document.body.removeEventListener("touchmove",this._onPanning))}},{key:"_setChartScale",value:function(e,t,n){var i=window.getComputedStyle(e).transform;if("none"===i)e.style.transform="scale("+t+","+t+")";else{var s=i.split(",");i.includes("3d")?e.style.transform=i+" scale3d("+t+","+t+", 1)":(s[0]="matrix("+t,s[3]=t,e.style.transform=i+" scale("+t+","+t+")")}n&&(e.style.transformOrigin=n),e.dataset.scale=t}},{key:"_onWheeling",value:function(e){e.preventDefault();var t=e.deltaY>0?.8:1.2;this._setChartScale(this.chart,t)}},{key:"_getPinchDist",value:function(e){return Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY))}},{key:"_onTouchStart",value:function(e){var t=this.chart;if(e.touches&&2===e.touches.length){var n=this._getPinchDist(e);t.dataset.pinching=!0,t.dataset.pinchDistStart=n}}},{key:"_onTouchMove",value:function(e){var t=this.chart;if(t.dataset.pinching){var n=this._getPinchDist(e);t.dataset.pinchDistEnd=n}}},{key:"_onTouchEnd",value:function(e){var t=this.chart;if(t.dataset.pinching){t.dataset.pinching=!1;var n=t.dataset.pinchDistEnd-t.dataset.pinchDistStart;n>0?this._setChartScale(t,1):n<0&&this._setChartScale(t,-1)}}},{key:"findChild",value:function(e,t){function n(e,t,s){for(var r=0;r<e.childNodes.length&&!s;r++){for(var a=e.childNodes[r],o=void 0!==a.className?a.className.split(" "):[],l=0,d=o.length;l<d;l++)if(o[l]===t){s=!0,i=e.childNodes[r];break}if(s)break;n(e.childNodes[r],t,s)}}var i=null;return n(e,t,!1),i}},{key:"findChilden",value:function(e,t){function n(e,t,s){for(var r=0;r<e.childNodes.length&&!s;r++){for(var a=e.childNodes[r],o=void 0!==a.className?a.className.split(" "):[],l=0,d=o.length;l<d;l++)if(o[l]===t){i.push(e.childNodes[r]);break}n(e.childNodes[r],t,s)}}var i=[];return n(e,t,!1),i}},{key:"findParents",value:function(e,t,n,i){for(var s=e,r=t?"id":n?"className":"tagName",a=[];s;)switch(s=s.parentNode,r){case"id":break;case"className":s&&s.className&&s.className.indexOf(n)>-1&&a.push(s);break;default:s&&s.nodeName===i.toUpperCase()&&a.push(s)}return a}},{key:"findSiblings",value:function(e){for(var t=[],n=e.nextSibling,i=e.previousSibling;i;)t.unshift(i),i=i.previousSibling;for(;n;)t.push(n),n=n.nextSibling;return t}},{key:"hideSiblingParent",value:function(e){var t=this,n=this.findParents(e,null,"verticalNodes")[0],i=this.findParents(n,null,null,"td")[0],s=this.findSiblings(i),r=this.findSiblings(this.chart);s.forEach(function(e){var n=t.findChild(e,"hide-parent-siblings");if(n){var i=n.parentNode;t._getNodeState(i,"parent").visible&&t.hideParent(n),t.showGhost(n)}}),this.hideSiblingChartParents(r)}},{key:"hideSiblingChartParents",value:function(e){var t=this;e.forEach(function(e){t.findChilden(e,"hide-parent-siblings").forEach(function(e){var n=e.parentNode;t._getNodeState(n,"parent").visible&&t.hideParent(e),t.showGhost(e)})})}},{key:"hideGhost",value:function(){var e=this,t=[],n=this.ghostLines;this.findSiblings(this.chart).forEach(function(t){var i=e.findChilden(t,"ghostRow");n=n.concat(i)});var i=n.filter(function(n){var i=n&&n.className&&n.className.indexOf("active")>-1;if(i){e._siblings(n).map(function(e){e&&e.className&&e.className.indexOf("lines")>-1&&t.push(e)})}return i});this._removeClass(i,"active"),this._addClass(t,"hidden")}},{key:"showGhost",value:function(e){var t=Array.from(this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children),n=t.filter(function(e){return e&&e.className&&e.className.indexOf("ghostRow")>-1}),i=t.filter(function(e){return e&&e.className&&e.className.indexOf("lines")>-1});this._addClass(n,"active"),this._removeClass(i,"hidden")}},{key:"name",get:function(){return this._name}}]),e}();exports.default=OrgChart;